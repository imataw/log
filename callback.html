<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GitHub 认证</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f6f8fa;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="loading">
        <h2>正在处理认证...</h2>
    </div>
    <script>
        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            
            // 验证 state
            const savedState = sessionStorage.getItem('oauth_state');
            if (state !== savedState) {
                alert('认证失败：state 不匹配');
                window.location.href = '/log';
                return;
            }
            
            if (code) {
                try {
                    // 触发 GitHub Action
                    const response = await fetch('https://api.github.com/repos/imataw/log/dispatches', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${GITHUB_PAT}` // 这个值会被 GitHub Action 替换
                        },
                        body: JSON.stringify({
                            event_type: 'oauth-callback',
                            client_payload: {
                                code: code,
                                redirect_uri: window.location.origin + '/log'
                            }
                        })
                    });

                    if (response.ok) {
                        // 等待 token
                        let attempts = 0;
                        const maxAttempts = 10;
                        const checkToken = async () => {
                            try {
                                const tokenResponse = await fetch('/log/token.json');
                                if (tokenResponse.ok) {
                                    const data = await tokenResponse.json();
                                    sessionStorage.setItem('github_token', data.access_token);
                                    window.location.href = '/log';
                                    return;
                                }
                            } catch (error) {
                                console.error('Error checking token:', error);
                            }
                            
                            attempts++;
                            if (attempts < maxAttempts) {
                                setTimeout(checkToken, 2000);
                            } else {
                                alert('认证超时，请重试');
                                window.location.href = '/log';
                            }
                        };
                        
                        checkToken();
                    } else {
                        throw new Error('Failed to trigger action');
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    alert('认证失败
