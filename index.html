<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布想法</title>
    <style>
        /* 保持原有样式不变 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f6f6f6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h2 {
            margin: 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        .btn {
            background-color: #0084ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        .btn:hover {
            background-color: #0077e6;
        }
        #thoughts-container {
            margin-top: 30px;
        }
        .thought-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        .thought-time {
            color: #8590a6;
            font-size: 12px;
            margin-top: 8px;
        }
        .search-container {
            margin: 20px 0;
        }
        .date-input {
            width: 100%;
        }
        .date-header {
            margin: 20px 0 10px;
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .date-header::after {
            content: "";
            flex: 1;
            height: 1px;
            background: #eee;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background: #f0f9eb;
            color: #67c23a;
            display: block;
        }
        .status.error {
            background: #fef0f0;
            color: #f56c6c;
            display: block;
        }
        .login-button {
            background-color: #2da44e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .login-button:hover {
            background-color: #2c974b;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-info img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>发布想法</h2>
            <div id="auth-section">
                <!-- 登录按钮或用户信息将在这里显示 -->
            </div>
        </div>

        <div class="form-group">
            <textarea id="thoughtContent" class="form-control" rows="4" placeholder="写下你的想法..."></textarea>
        </div>

        <button class="btn" onclick="publishThought()">发布</button>

        <div class="search-container">
            <div class="date-input">
                <label>选择日期</label>
                <input type="date" id="searchDate" class="form-control" onchange="searchThoughts()">
            </div>
        </div>

        <div id="thoughts-container">
            <!-- 已发布的想法将显示在这里 -->
        </div>
    </div>

    <script>
        let thoughts = [];
        let config = null;

        // 检测当前环境
        function isProduction() {
            return window.location.hostname.includes('github.io');
        }

        // 获取当前环境的redirectUri
        function getRedirectUri() {
            if (!config || !config.redirectUri) return null;
            // 如果URL中包含index.html，使用完整的redirectUri
            if (window.location.href.includes('index.html')) {
                return isProduction() ? config.redirectUri.production : config.redirectUri.development;
            }
            // 否则使用不带index.html的URL
            return isProduction() 
                ? config.redirectUri.production.replace('/index.html', '/') 
                : config.redirectUri.development.replace('/index.html', '/');
        }

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                config = await response.json();
                const redirectUri = getRedirectUri();
                if (!config.clientId || !redirectUri) {
                    showStatus('请在config.json中设置GitHub OAuth配置', 'error');
                }
                console.log('Current redirect URI:', redirectUri); // 添加调试信息
            } catch (error) {
                console.error('加载配置失败:', error);
                showStatus('加载配置失败', 'error');
            }
        }

        const SCOPE = 'gist,repo'; // 需要的权限范围

        // 登录函数
        async function login() {
            if (!config) {
                await loadConfig();
            }
            const redirectUri = getRedirectUri();
            if (!config || !config.clientId || !redirectUri) {
                showStatus('GitHub OAuth配置未设置', 'error');
                return;
            }

            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('oauth_state', state);
            const authUrl = `https://github.com/login/oauth/authorize?` +
                `client_id=${config.clientId}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${SCOPE}&` +
                `state=${state}&` +
                `response_type=token`; // 使用implicit grant flow
            window.location.href = authUrl;
        }

        // 处理OAuth回调
        async function handleCallback() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token=')) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                const state = params.get('state');
                const savedState = localStorage.getItem('oauth_state');

                if (state === savedState) {
                    localStorage.setItem('github_token', token);
                    // 清除URL中的token
                    window.history.replaceState({}, document.title, window.location.pathname);
                    await checkAuth();
                    return;
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                showStatus(`GitHub登录失败: ${error}`, 'error');
                return;
            }
        }

        // 检查用户登录状态
        async function checkAuth() {
            const token = localStorage.getItem('github_token');
            const authSection = document.getElementById('auth-section');
            
            if (token) {
                try {
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${token}`
                        }
                    });
                    if (response.ok) {
                        const user = await response.json();
                        authSection.innerHTML = `
                            <div class="user-info">
                                <img src="${user.avatar_url}" alt="Avatar">
                                <span>${user.login}</span>
                            </div>
                        `;
                        return true;
                    }
                } catch (error) {
                    console.error('Failed to get user info:', error);
                }
                // 如果获取用户信息失败，清除token
                localStorage.removeItem('github_token');
            }
            
            // 如果没有token或token无效，显示登录按钮
            authSection.innerHTML = `
                <button onclick="login()" class="login-button">
                    <svg height="16" viewBox="0 0 16 16" width="16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                    </svg>
                    使用GitHub登录
                </button>
            `;
            return false;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // 从GitHub加载数据
        async function loadThoughts() {
            try {
                const response = await callGitHubApi(`/repos/${localStorage.getItem('github_username')}/${localStorage.getItem('github_repo')}/contents/thoughts.json`);
                if (response.content) {
                    const decodedContent = atob(response.content);
                    thoughts = JSON.parse(decodedContent);
                    renderThoughts(thoughts);
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showStatus('加载数据失败', 'error');
            }
        }

        // 保存数据到GitHub
        async function saveThoughts() {
            try {
                // 首先获取文件的SHA（如果存在）
                let sha = '';
                try {
                    const response = await callGitHubApi(`/repos/${localStorage.getItem('github_username')}/${localStorage.getItem('github_repo')}/contents/thoughts.json`);
                    sha = response.sha;
                } catch (error) {
                    // 如果文件不存在，这里会抛出错误，我们可以忽略
                    console.log('文件不存在，将创建新文件');
                }

                const content = JSON.stringify(thoughts, null, 2);
                const payload = {
                    message: '更新想法',
                    content: btoa(content),
                    ...(sha && {sha: sha})
                };

                await callGitHubApi(`/repos/${localStorage.getItem('github_username')}/${localStorage.getItem('github_repo')}/contents/thoughts.json`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });

                showStatus('保存成功', 'success');
            } catch (error) {
                console.error('保存失败:', error);
                showStatus('保存失败', 'error');
            }
        }

        // 修改现有的API调用函数，添加认证header
        async function callGitHubApi(endpoint, options = {}) {
            const token = localStorage.getItem('github_token');
            if (!token) {
                throw new Error('未登录');
            }

            const response = await fetch(`https://api.github.com${endpoint}`, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                throw new Error(`GitHub API 错误: ${response.statusText}`);
            }

            return response.json();
        }

        function formatDate(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatFullDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function publishThought() {
            const content = document.getElementById('thoughtContent').value.trim();
            if (!content) {
                alert('请输入想法内容');
                return;
            }

            const now = new Date();
            const thought = {
                id: Date.now(),
                content: content,
                timestamp: now.getTime(),
                formattedTime: formatDate(now),
                fullDate: formatFullDate(now)
            };

            thoughts.push(thought);
            try {
                await saveThoughts();
                renderThoughts(thoughts);
                document.getElementById('thoughtContent').value = '';
                showStatus('发布成功', 'success');
            } catch (error) {
                thoughts.pop(); // 如果保存失败，移除刚才添加的想法
                showStatus('发布失败', 'error');
            }
        }

        function renderThoughts(thoughtsToShow) {
            const thoughtsContainer = document.getElementById('thoughts-container');
            thoughtsContainer.innerHTML = '';

            let currentDate = '';
            thoughtsToShow.sort((a, b) => b.timestamp - a.timestamp);

            thoughtsToShow.forEach(thought => {
                if (thought.fullDate !== currentDate) {
                    currentDate = thought.fullDate;
                    const dateElement = document.createElement('div');
                    dateElement.className = 'date-header';
                    dateElement.textContent = currentDate;
                    thoughtsContainer.appendChild(dateElement);
                }

                const thoughtElement = document.createElement('div');
                thoughtElement.className = 'thought-item';
                thoughtElement.innerHTML = `
                    <div>${thought.content}</div>
                    <div class="thought-time">${thought.formattedTime}</div>
                `;
                thoughtsContainer.appendChild(thoughtElement);
            });

            if (thoughtsToShow.length === 0) {
                thoughtsContainer.innerHTML = '<div style="text-align: center; color: #999; margin-top: 30px;">暂无想法</div>';
            }
        }

        function searchThoughts() {
            const searchDate = document.getElementById('searchDate').value;
            if (!searchDate) {
                renderThoughts(thoughts);
                return;
            }

            const filteredThoughts = thoughts.filter(thought => thought.fullDate === searchDate);
            renderThoughts(filteredThoughts);
        }

        // 页面加载时检查认证状态
        window.addEventListener('load', async () => {
            await loadConfig(); // 首先加载配置
            await checkAuth();
            // 检查是否是OAuth回调
            if (window.location.search.includes('code=')) {
                await handleCallback();
            }
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            document.getElementById('searchDate').value = today;
            loadThoughts();
        });
    </script>
</body>
</html>
